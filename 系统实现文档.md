# 电商系统实现文档

## 1. 系统概述

本系统是一个基于数据库设计的电商平台，实现了用户管理、商品管理、购物车、订单管理等核心功能。系统采用前后端分离架构，前端使用Vue.js框架，后端基于FastAPI开发，数据库采用SQL Server实现。

### 1.1 系统目标
- 提供完整的电商交易流程
- 实现用户管理与认证
- 支持商品展示与搜索
- 实现购物车功能
- 支持订单创建与管理
- 提供地址管理功能
- 实现简单的促销功能

## 2. 技术栈

| 类别 | 技术 | 版本/说明 |
|------|------|-----------|
| 后端框架 | FastAPI | Python Web框架 |
| 前端框架 | Vue.js | 前端UI框架 |
| 数据库 | SQL Server | 关系型数据库 |
| 认证方式 | JWT | JSON Web Token |
| API文档 | Swagger | 自动生成API文档 |
| 数据交互 | RESTful API | 前后端数据交互 |

## 3. 系统架构

### 3.1 整体架构

系统采用前后端分离架构，主要分为以下几个层次：

1. **前端层**：使用Vue.js构建用户界面，包括商品展示、用户管理、购物车和订单等页面。
2. **API层**：基于FastAPI实现RESTful API，处理前端请求并与数据库交互。
3. **数据访问层**：封装数据库操作，提供统一的数据访问接口。
4. **数据库层**：使用SQL Server存储系统数据，包括用户、商品、订单等信息。

### 3.2 模块划分

系统主要分为以下功能模块：

- **用户认证模块**：处理用户登录、注册、信息查询与修改
- **用户管理模块**：管理用户地址等信息
- **商品管理模块**：提供商品展示、搜索、详情查询等功能
- **购物车模块**：实现购物车的增删改查功能
- **订单管理模块**：处理订单的创建、支付、查询等功能

## 4. 功能模块实现

### 4.1 用户认证模块

#### 4.1.1 功能概述
- 用户登录：支持用户名或邮箱登录
- 用户注册：创建新用户账号
- 用户信息查询：获取当前登录用户信息
- 用户信息更新：修改用户基本信息
- 密码修改：修改用户密码

#### 4.1.2 核心实现

```python
# 用户登录实现
@router.post("/login", response_model=Token)
async def login(user_data: UserLogin):
    # 查询用户信息
    user_result = db.execute_query(
        "SELECT user_id, username, password, user_type FROM [User] WHERE username = ? OR email = ?",
        (user_data.username, user_data.username)
    )
    
    # 密码验证
    if user_data.password != stored_password:
        raise HTTPException(status_code=401, detail="用户名或密码错误")
    
    # 创建JWT Token
    access_token = create_access_token(data={"sub": str(user["user_id"])})
    
    return {"access_token": access_token, "token_type": "bearer"}
```

### 4.2 用户管理模块

#### 4.2.1 功能概述
- 地址管理：添加、删除、修改、查询用户收货地址
- 默认地址设置：设置默认收货地址

#### 4.2.2 核心实现

```python
# 获取地址列表
@router.get("/addresses", response_model=dict)
async def get_addresses(current_user: dict = Depends(get_current_user)):
    addresses = db.execute_query(
        "SELECT * FROM Address WHERE user_id = ? ORDER BY is_default DESC, address_id DESC",
        (current_user["user_id"],)
    )
    return {"code": 200, "message": "success", "data": addresses}

# 添加新地址
@router.post("/addresses")
async def create_address(
    address_data: AddressCreate,
    current_user: dict = Depends(get_current_user)
):
    # 如果设置为默认地址，需要取消其他地址的默认状态
    if address_data.is_default:
        db.execute_update(
            "UPDATE Address SET is_default = 0 WHERE user_id = ?",
            (user_id,)
        )
    
    # 插入新地址
    sql = """INSERT INTO Address (address_id, user_id, receiver_name, receiver_phone, detail_address, postal_code, is_default) VALUES (?, ?, ?, ?, ?, ?, ?)"""
    db.execute_update(sql, params)
```

### 4.3 商品管理模块

#### 4.3.1 功能概述
- 商品列表：展示商品信息，支持分页和筛选
- 商品分类：获取商品分类信息
- 商品详情：查看单个商品的详细信息
- 促销信息：展示商品的促销价格和活动

#### 4.3.2 核心实现

```python
# 获取商品列表
@router.get("/")
async def get_products(keyword: Optional[str] = None, category_id: Optional[int] = None, min_price: Optional[float] = None, max_price: Optional[float] = None, page: int = 1, page_size: int = 20):
    # 构建查询条件
    conditions = ["p.product_status = 1"]  # 只查询上架商品
    params = []
    
    if keyword:
        conditions.append("(p.product_name LIKE ? OR p.description LIKE ?)")
        params.extend([f"%{keyword}%", f"%{keyword}%"])
    
    # 分页查询
    offset = (page - 1) * page_size
    query_sql = f"""SELECT p.product_id AS id, p.product_name AS name, p.description, p.price, p.stock_quantity AS stock, p.image, c.category_name, c.category_id, 0 AS sold_quantity FROM Product p LEFT JOIN Category c ON p.category_id = c.category_id WHERE {where_clause} ORDER BY p.product_id DESC OFFSET ? ROWS FETCH NEXT ? ROWS ONLY"""
    
    products = db.execute_query(query_sql, params_with_paging)
    
    # 处理促销信息
    for product in products:
        # 获取该商品的促销信息
        promotion_query = """SELECT pr.promotion_id, pr.discount_tyoe AS discount_type, pr.discount_value, pr.start_time, pr.end_time, pr.promotion_status FROM Promotion pr JOIN Product_Promotion pp ON pr.promotion_id = pp.promotion_id WHERE pp.product_id = ? AND pr.promotion_status = 1 AND GETDATE() BETWEEN pr.start_time AND pr.end_time"""
        promotion_result = db.execute_query(promotion_query, (product["id"],))
        
        # 计算最优促销价格
        if promotion_result:
            # 处理促销逻辑，计算折后价
            has_discount = True
            discounted_price = ...
            promotion_tag = ...
    
    return {"code": 200, "message": "success", "data": {"items": formatted_products, "total": total, "page": page, "page_size": page_size}}
```

### 4.4 购物车模块

#### 4.4.1 功能概述
- 购物车列表：查看当前购物车中的商品
- 添加商品：将商品添加到购物车
- 更新数量：修改购物车中商品的数量
- 删除商品：从购物车中删除商品
- 批量删除：批量删除购物车中的商品
- 清空购物车：清空当前用户的购物车

#### 4.4.2 核心实现

```python
# 获取购物车列表
@router.get("/")
async def get_cart(current_user: dict = Depends(get_current_user)):
    sql = """SELECT c.cart_id, c.user_id, c.product_id, c.cart_quantity, c.add_time, p.product_name, p.price, p.image AS image_url, p.stock_quantity, p.product_status FROM Cart c INNER JOIN Product p ON c.product_id = p.product_id WHERE c.user_id = ? AND p.product_status = 1 ORDER BY c.add_time DESC"""
    items = db.execute_query(sql, (current_user["user_id"],))
    
    # 计算统计信息
    total_items = len(items)
    cart_total = sum(item["price"] * item["cart_quantity"] for item in items) if items else 0
    
    return {"code": 200, "message": "success", "data": {"items": items, "summary": {"total_items": total_items, "total_amount": cart_total}}}

# 添加商品到购物车
@router.post("/add")
async def add_to_cart(item: CartItem, current_user: dict = Depends(get_current_user)):
    # 调用存储过程
    result = db.execute_proc("sp_AddToCart", [current_user["user_id"], item.product_id, item.quantity])
    return {"code": 200, "message": "添加成功", "data": result[0] if result else []}
```

### 4.5 订单管理模块

#### 4.5.1 功能概述
- 订单列表：查看用户的订单历史
- 创建订单：从购物车创建订单
- 订单详情：查看单个订单的详细信息
- 订单支付：完成订单支付

#### 4.5.2 核心实现

```python
# 创建订单
@router.post("/")
async def create_order(order_data: OrderCreate, current_user: dict = Depends(get_current_user)):
    # 调用存储过程
    result = db.execute_proc("sp_CreateOrder", [current_user["user_id"], order_data.address_id, 0])
    
    if result and len(result) > 0:
        order_info = result[0]
        return {"code": 200, "message": "订单创建成功", "data": order_info}
    else:
        raise HTTPException(status_code=400, detail="订单创建失败")

# 获取订单列表
@router.get("/")
async def get_orders(status: Optional[int] = None, page: int = 1, page_size: int = 10, current_user: dict = Depends(get_current_user)):
    # 查询订单列表
    orders = db.execute_query('SELECT o.order_id, o.user_id, o.address_id, o.total_amount, o.order_status, o.create_time, o.pay_time, o.ship_time, a.receiver_name, a.receiver_phone, a.detail_address FROM [Order] o LEFT JOIN Address a ON o.address_id = a.address_id WHERE o.user_id = ? ORDER BY o.create_time DESC OFFSET ? ROWS FETCH NEXT ? ROWS ONLY', (current_user["user_id"], offset, page_size))
    
    # 处理每个订单，添加必要的字段
    processed_orders = []
    for order in orders:
        # 获取订单商品
        items_sql = 'SELECT oi.item_id, oi.order_id, oi.product_id, oi.order_quantity AS quantity, oi.unit_price, oi.subtotal, p.image AS product_image, p.product_name FROM OrderItem oi LEFT JOIN Product p ON oi.product_id = p.product_id WHERE oi.order_id = ?'
        items = db.execute_query(items_sql, (order["order_id"],))
        
        # 构建完整的订单数据
        processed_order = {
            **order,
            "order_no": f"ORD{order['order_id']:08d}",
            "shipping_fee": 0.0,
            "final_amount": order["total_amount"],
            "items": items,
            "item_count": len(items)
        }
        
        processed_orders.append(processed_order)
    
    return {"code": 200, "message": "success", "data": {"items": processed_orders, "total": total_count, "page": page, "page_size": page_size}}
```

## 5. 数据库设计

### 5.1 数据库结构

系统包含以下主要表结构：

1. **User** - 用户表
2. **Category** - 商品分类表
3. **Product** - 商品表
4. **Promotion** - 促销表
5. **Product_Promotion** - 商品促销关联表
6. **Address** - 地址表
7. **Cart** - 购物车表
8. **Order** - 订单表
9. **OrderItem** - 订单商品表
10. **Payment** - 支付表

### 5.2 表关系

- User 与 Address：一对多关系
- User 与 Cart：一对多关系
- User 与 Order：一对多关系
- Order 与 OrderItem：一对多关系
- Order 与 Payment：一对一关系
- Product 与 Category：多对一关系
- Product 与 Product_Promotion：多对多关系
- Promotion 与 Product_Promotion：多对多关系

### 5.3 核心存储过程

系统使用了多个存储过程来实现业务逻辑：

1. **sp_RegisterUser** - 用户注册
2. **sp_UpdateUserInfo** - 更新用户信息
3. **sp_AddToCart** - 添加商品到购物车
4. **sp_ClearCart** - 清空购物车
5. **sp_CreateOrder** - 创建订单
6. **sp_PayOrder** - 支付订单

## 6. API接口

### 6.1 用户认证API

| 接口 | 方法 | 功能 |
|------|------|------|
| /auth/login | POST | 用户登录 |
| /auth/register | POST | 用户注册 |
| /auth/me | GET | 获取当前用户信息 |
| /auth/profile | PUT | 更新用户信息 |
| /auth/password | PUT | 修改密码 |

### 6.2 用户管理API

| 接口 | 方法 | 功能 |
|------|------|------|
| /user/addresses | GET | 获取地址列表 |
| /user/addresses | POST | 添加新地址 |
| /user/addresses/{address_id} | PUT | 修改地址 |
| /user/addresses/{address_id} | DELETE | 删除地址 |
| /user/addresses/{address_id}/default | PUT | 设置默认地址 |

### 6.3 商品管理API

| 接口 | 方法 | 功能 |
|------|------|------|
| /products | GET | 获取商品列表 |
| /products/{product_id} | GET | 获取商品详情 |
| /products/categories | GET | 获取商品分类 |

### 6.4 购物车API

| 接口 | 方法 | 功能 |
|------|------|------|
| /cart | GET | 获取购物车列表 |
| /cart/add | POST | 添加商品到购物车 |
| /cart/{product_id} | PUT | 更新购物车商品数量 |
| /cart/{product_id} | DELETE | 从购物车删除商品 |
| /cart/batch | DELETE | 批量删除购物车商品 |
| /cart | DELETE | 清空购物车 |

### 6.5 订单管理API

| 接口 | 方法 | 功能 |
|------|------|------|
| /orders | GET | 获取订单列表 |
| /orders | POST | 创建订单 |
| /orders/{order_id} | GET | 获取订单详情 |
| /orders/{order_id}/pay | POST | 支付订单 |

## 7. 系统流程

### 7.1 用户注册流程

1. 用户提交注册信息
2. 系统验证信息完整性
3. 调用sp_RegisterUser存储过程创建用户
4. 返回注册结果

### 7.2 用户登录流程

1. 用户提交登录信息
2. 系统验证用户名/邮箱和密码
3. 生成JWT Token
4. 返回Token和用户信息

### 7.3 商品购买流程

1. 用户浏览商品列表
2. 将商品添加到购物车
3. 在购物车中确认购买商品
4. 选择收货地址
5. 创建订单
6. 选择支付方式
7. 完成支付
8. 系统更新订单状态

### 7.4 地址管理流程

1. 用户进入地址管理页面
2. 查看现有地址列表
3. 可以添加新地址、修改地址、删除地址或设置默认地址
4. 系统更新地址信息

## 8. 系统部署

### 8.1 后端部署

1. 安装Python依赖
```bash
pip install -r requirements.txt
```

2. 启动后端服务
```bash
python main.py
```

3. 访问API文档
```
http://localhost:8000/docs
```

### 8.2 前端部署

1. 安装依赖
```bash
npm install
```

2. 启动开发服务器
```bash
npm run dev
```

3. 构建生产版本
```bash
npm run build
```

### 8.3 数据库配置

1. 创建数据库
2. 执行data.sql初始化数据库结构和数据
3. 在database.py中配置数据库连接信息

## 9. 系统测试

系统提供了基本的测试接口，可以通过以下方式测试：

1. 健康检查接口：`GET /health`
2. API文档：`GET /docs`
3. 测试数据接口：`GET /test`

## 10. 总结

本系统实现了一个基本的电商平台功能，包括用户管理、商品管理、购物车和订单管理等核心功能。系统采用前后端分离架构，具有良好的可扩展性和可维护性。

### 10.1 已实现功能
- ✅ 用户注册与登录
- ✅ 用户信息管理
- ✅ 地址管理
- ✅ 商品展示与搜索
- ✅ 购物车功能
- ✅ 订单创建与管理
- ✅ 简单的促销功能

### 10.2 待优化功能
- ⏳ 更完善的促销系统
- ⏳ 商品评价功能
- ⏳ 物流跟踪功能
- ⏳ 更完善的权限管理
- ⏳ 性能优化

## 11. 参考资料

1. FastAPI官方文档
2. Vue.js官方文档
3. SQL Server数据库设计规范
4. RESTful API设计指南
5. JWT认证机制
